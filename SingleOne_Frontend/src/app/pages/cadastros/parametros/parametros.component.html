<!-- üéØ HEADER MODERNO DOS PAR√ÇMETROS -->
<div class="parametros-header">
  <div class="header-content">
    <div class="header-left">
      <button class="back-button" [routerLink]="['/configuracoes']" matTooltip="Voltar para Configura√ß√µes">
        <i class="material-icons">arrow_back</i>
      </button>
      <div class="header-title">
        <div class="title-icon">
          <i class="material-icons">settings</i>
        </div>
        <div class="title-text">
          <h1>Par√¢metros do Sistema</h1>
          <p>Configura√ß√µes gerais e comportamentos do sistema</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üçû BREADCRUMB MODERNO -->
<nav class="modern-breadcrumb">
  <div class="breadcrumb-container">
    <a [routerLink]="['/dashboard']" class="breadcrumb-item">
      <i class="material-icons">home</i>
      <span>Dashboard</span>
    </a>
    <i class="material-icons">chevron_right</i>
    <a [routerLink]="['/configuracoes']" class="breadcrumb-item">
      <i class="material-icons">settings</i>
      <span>Configura√ß√µes</span>
    </a>
    <i class="material-icons">chevron_right</i>
    <span class="breadcrumb-item active">Par√¢metros</span>
  </div>
</nav>

<!-- üìã CONTE√öDO PRINCIPAL -->
<div class="parametros-content">
  <form [formGroup]="form" (ngSubmit)="salvar()">
    

    <!-- üìß CARD: CONFIGURA√á√ÉO DE E-MAIL PARA DESCONTOS -->
    <div class="parametro-card">
      <div class="card-header">
        <div class="header-icon">
          <i class="material-icons">email</i>
        </div>
        <div class="header-text">
          <h2>E-mail para Descontos de Sinistros</h2>
          <p>Notifica√ß√µes sobre reportes de recursos ou laudos</p>
        </div>
        <div class="header-action">
          <mat-slide-toggle color="primary" formControlName="emailDescontosEnabled" (change)="onEmailDescontosEnabledChange()">
          </mat-slide-toggle>
        </div>
      </div>
      <div class="card-content">
        <p>Configura√ß√£o do e-mail para notifica√ß√µes sobre reportes de recursos ou laudos caracterizando mau uso.</p>
        
        <div class="form-row" *ngIf="form.get('emailDescontosEnabled')?.value">
          <mat-form-field appearance="outline" class="email-input">
            <mat-label>E-mail do setor respons√°vel</mat-label>
            <input matInput required formControlName="emailReporte" placeholder="setor@empresa.com">
            <mat-error *ngIf="form.get('emailReporte')?.hasError('required')">E-mail √© obrigat√≥rio</mat-error>
            <mat-error *ngIf="form.get('emailReporte')?.hasError('email')">E-mail inv√°lido</mat-error>
          </mat-form-field>
        </div>
      </div>
    </div>

    <!-- üì° CARD: CONFIGURA√á√ïES DE E-MAIL (SMTP) -->
    <div class="parametro-card" *ngIf="isAdmin">
      <div class="card-header">
        <div class="header-icon">
          <i class="material-icons">dns</i>
        </div>
        <div class="header-text">
          <h2>Configura√ß√µes de E-mail (SMTP)</h2>
          <p>Servidor de envio de e-mails do sistema</p>
        </div>
        <div class="header-action">
          <mat-slide-toggle color="primary" formControlName="smtpEnabled" (change)="onSmtpEnabledChange()">
          </mat-slide-toggle>
        </div>
      </div>
      <div class="card-content">
        <p>Configura√ß√µes para envio de e-mails via servidor SMTP. Apenas administradores podem alterar estas configura√ß√µes.</p>
        
        <!-- Dicas de configura√ß√£o -->
        <div class="config-tips" *ngIf="form.get('smtpEnabled')?.value">
          <h4>üí° Dicas de configura√ß√£o:</h4>
          <div class="tips-grid">
            <div class="tip-item">
              <strong>Gmail:</strong> smtp.gmail.com:587 (TLS) ou 465 (SSL)
            </div>
            <div class="tip-item">
              <strong>Outlook:</strong> smtp-mail.outlook.com:587 (TLS)
            </div>
            <div class="tip-item">
              <strong>Brevo:</strong> smtp-relay.brevo.com:587 (TLS)
            </div>
            <div class="tip-item">
              <strong>Yahoo:</strong> smtp.mail.yahoo.com:587 (TLS) ou 465 (SSL)
            </div>
          </div>
        </div>

        <!-- Campos SMTP -->
        <div class="form-grid" *ngIf="form.get('smtpEnabled')?.value">
          <mat-form-field appearance="outline">
            <mat-label>Host SMTP *</mat-label>
            <input matInput formControlName="smtpHost" placeholder="smtp.gmail.com">
            <mat-error *ngIf="form.get('smtpHost')?.hasError('required')">Host SMTP √© obrigat√≥rio</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Usu√°rio SMTP *</mat-label>
            <input matInput formControlName="smtpLogin" placeholder="seu-email@gmail.com">
            <mat-error *ngIf="form.get('smtpLogin')?.hasError('required')">Usu√°rio SMTP √© obrigat√≥rio</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Senha SMTP *</mat-label>
            <input matInput type="password" formControlName="smtpPassword" placeholder="Sua senha ou senha de app">
            <mat-error *ngIf="form.get('smtpPassword')?.hasError('required')">Senha SMTP √© obrigat√≥ria</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>E-mail de Origem *</mat-label>
            <input matInput formControlName="smtpEmailFrom" placeholder="noreply@seudominio.com">
            <mat-error *ngIf="form.get('smtpEmailFrom')?.hasError('required')">E-mail de origem √© obrigat√≥rio</mat-error>
            <mat-error *ngIf="form.get('smtpEmailFrom')?.hasError('email')">E-mail inv√°lido</mat-error>
          </mat-form-field>

          <div class="ssl-toggle">
            <mat-label>Habilitar SSL</mat-label>
            <mat-slide-toggle color="primary" formControlName="smtpEnableSSL" (change)="onSslChange()">
            </mat-slide-toggle>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Porta SMTP *</mat-label>
            <input matInput type="number" formControlName="smtpPort" 
                   [placeholder]="form.get('smtpEnableSSL')?.value ? '465' : '587'">
            <mat-hint>{{ form.get('smtpEnableSSL')?.value ? 'Porta padr√£o para SSL: 465' : 'Porta padr√£o para TLS: 587' }}</mat-hint>
            <mat-error *ngIf="form.get('smtpPort')?.hasError('required')">Porta √© obrigat√≥ria</mat-error>
            <mat-error *ngIf="form.get('smtpPort')?.hasError('min')">Porta deve ser maior que 0</mat-error>
            <mat-error *ngIf="form.get('smtpPort')?.hasError('max')">Porta deve ser menor que 65536</mat-error>
          </mat-form-field>
        </div>

        <!-- Status e a√ß√µes SMTP -->
        <div class="card-actions" *ngIf="form.get('smtpEnabled')?.value">
          <div class="action-buttons">
            <button type="button" 
                    class="btn-test"
                    [disabled]="!isFormSMTPValido()" 
                    (click)="testarConexaoSMTP()">
              <i class="material-icons">send</i>
              Testar Conex√£o
            </button>
          </div>

          <!-- Status da valida√ß√£o -->
          <div class="validation-status">
            <div class="alert alert-warning" *ngIf="!isFormSMTPValido()">
              <i class="material-icons">warning</i>
              <span>Preencha todos os campos obrigat√≥rios para habilitar o teste de conex√£o SMTP.</span>
            </div>
            <div class="alert alert-success" *ngIf="isFormSMTPValido()">
              <i class="material-icons">check_circle</i>
              <span>Configura√ß√£o v√°lida! Voc√™ pode testar a conex√£o SMTP.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üîê CARD: CONFIGURA√á√ïES DE AUTENTICA√á√ÉO DE DUPLO FATOR (2FA) -->
    <div class="parametro-card" *ngIf="isAdmin">
      <div class="card-header">
        <div class="header-icon">
          <i class="material-icons">security</i>
        </div>
        <div class="header-text">
          <h2>Autentica√ß√£o de Duplo Fator (2FA)</h2>
          <p>Seguran√ßa adicional para acesso ao sistema</p>
        </div>
        <div class="header-action">
          <mat-slide-toggle color="primary" formControlName="twoFactorEnabled" (change)="onTwoFactorEnabledChange()">
          </mat-slide-toggle>
        </div>
      </div>
      <div class="card-content">
        <p>Configura√ß√µes para autentica√ß√£o de duplo fator. <strong>Requer SMTP habilitado.</strong></p>
        
        <!-- Aviso sobre depend√™ncia SMTP -->
        <div class="alert alert-info" *ngIf="!form.get('smtpEnabled')?.value">
          <i class="material-icons">info</i>
          <span><strong>Pr√©-requisito:</strong> O SMTP deve estar habilitado para ativar a funcionalidade de 2FA.</span>
        </div>
        
        <!-- Configura√ß√µes 2FA quando habilitado -->
        <div class="form-grid" *ngIf="form.get('twoFactorEnabled')?.value && form.get('smtpEnabled')?.value">
          <mat-form-field appearance="outline">
            <mat-label>Tipo de 2FA</mat-label>
            <mat-select formControlName="twoFactorType">
              <mat-option value="email">Apenas E-mail</mat-option>
              <mat-option value="app">Aplicativo (Google Authenticator)</mat-option>
              <mat-option value="both">Ambos (E-mail + App)</mat-option>
            </mat-select>
            <mat-hint>Escolha o m√©todo de verifica√ß√£o para 2FA</mat-hint>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Tempo de Expira√ß√£o (minutos)</mat-label>
            <input matInput type="number" formControlName="twoFactorExpirationMinutes" min="1" max="60">
            <mat-hint>Tempo de validade do c√≥digo 2FA</mat-hint>
            <mat-error *ngIf="form.get('twoFactorExpirationMinutes')?.hasError('min')">M√≠nimo 1 minuto</mat-error>
            <mat-error *ngIf="form.get('twoFactorExpirationMinutes')?.hasError('max')">M√°ximo 60 minutos</mat-error>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>M√°ximo de Tentativas</mat-label>
            <input matInput type="number" formControlName="twoFactorMaxAttempts" min="1" max="10">
            <mat-hint>N√∫mero m√°ximo de tentativas antes do bloqueio</mat-hint>
            <mat-error *ngIf="form.get('twoFactorMaxAttempts')?.hasError('min')">M√≠nimo 1 tentativa</mat-error>
            <mat-error *ngIf="form.get('twoFactorMaxAttempts')?.hasError('max')">M√°ximo 10 tentativas</mat-error>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Tempo de Bloqueio (minutos)</mat-label>
            <input matInput type="number" formControlName="twoFactorLockoutMinutes" min="5" max="1440">
            <mat-hint>Tempo de bloqueio ap√≥s exceder tentativas</mat-hint>
            <mat-error *ngIf="form.get('twoFactorLockoutMinutes')?.hasError('min')">M√≠nimo 5 minutos</mat-error>
            <mat-error *ngIf="form.get('twoFactorLockoutMinutes')?.hasError('max')">M√°ximo 1440 minutos (24h)</mat-error>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Template do E-mail 2FA</mat-label>
            <textarea matInput formControlName="twoFactorEmailTemplate" rows="3" 
                      placeholder="Seu c√≥digo de verifica√ß√£o √©: {{ '{' }}CODE{{ '}' }}. Este c√≥digo expira em {{ '{' }}EXPIRATION{{ '}' }} minutos."></textarea>
            <mat-hint>Use {{ '{' }}CODE{{ '}' }} para o c√≥digo e {{ '{' }}EXPIRATION{{ '}' }} para o tempo de expira√ß√£o</mat-hint>
            <mat-error *ngIf="form.get('twoFactorEmailTemplate')?.hasError('required')">Template √© obrigat√≥rio</mat-error>
          </mat-form-field>
        </div>

        <!-- Informa√ß√µes sobre 2FA -->
        <div class="info-section" *ngIf="form.get('twoFactorEnabled')?.value && form.get('smtpEnabled')?.value">
          <h4>‚ÑπÔ∏è Como funciona o 2FA:</h4>
          <div class="info-grid">
            <div class="info-item">
              <strong>E-mail:</strong> C√≥digo enviado por e-mail a cada login
            </div>
            <div class="info-item">
              <strong>App:</strong> C√≥digo gerado por aplicativos como Google Authenticator
            </div>
            <div class="info-item">
              <strong>Seguran√ßa:</strong> Protege contra acesso n√£o autorizado mesmo com senha comprometida
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üöÄ A√á√ïES GLOBAIS -->
    <div class="global-actions">
      <div class="action-buttons">
        <button type="button" 
                class="btn-secondary"
                (click)="route.navigate(['/configuracoes'])">
          <i class="material-icons">arrow_back</i>
          Voltar para Configura√ß√µes
        </button>
        
        <button type="submit" 
                class="btn-primary">
          <i class="material-icons">save_all</i>
          SALVAR TUDO
        </button>
      </div>
    </div>

  </form>
</div>
